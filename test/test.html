<!doctype html>
<html>
  <head>
    <title>Bobble Test</title>
<style type="text/css">
.js-test-result-status { padding: 10px; margin: 2px; }
.js-test-result-status pre { padding: 0; margin: 0; }
.js-test-result-status-success { background-color: #A0FFA0; max-height: 5px; overflow: hidden; }
.js-test-result-status-success:hover { max-height: 1000px; }
.js-test-result-status-success .js-test-failure-message { display: none; }
.js-test-result-status-failure { background-color: #FF8080; }
.js-test-result-status .js-test-failure-message { margin: 15px 10px 10px; font-weight: bold; }
</style>
    <script type="text/javascript" language="JavaScript" src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.1.0/prototype.js"></script>
    <script type="text/javascript" language="JavaScript" src="../src/bobble.js"></script>
  </head>
  <body>

<script class="js-test-result-template" type="text/html">
<div class="js-test-result-status js-test-result-status-#{test_result}">
  <pre>#{function_body}</pre>
  <pre class="js-test-failure-message">#{failure_message}</pre>
</div>
</script>
<script class="js-test-results-summary-template" type="text/html">
<div class="js-test-results-summary">
  <pre>#{successes} Successes, #{failures} Failures</pre>
</div>
</script>

<script class="js-test" type="text/html">
assertThrows(function() {
  advanceToTime(1);
  advanceToTime(0);
}, "Expected error to have been raised when attempting to rewind time");
</script>

<script class="js-test" type="text/html">
var a = false;

advanceToTime(50);

setTimeout(
  function() { a = true; },
  100);

advanceToTime(149);
assertEquals(false, a, "Expected setTimeout not to have fired after 149 simulated milliseconds");

advanceToTime(150);
assertEquals(true, a, "Expected setTimeout to have fired after 150 simulated milliseconds");

a = false;
advanceToTime(250);
assertEquals(false, a, "Expected setTimeout not to have fired again after 250 simulated milliseconds");
</script>

<script class="js-test" type="text/html">
var a = false;

advanceToTime(50);

setInterval(
  function() { a = true; },
  100);

advanceToTime(149);
assertEquals(false, a, "Expected setInterval not to have fired after 149 simulated milliseconds");

advanceToTime(150);
assertEquals(true, a, "Expected setInterval to have fired after 150 simulated milliseconds");

a = false;
advanceToTime(249);
assertEquals(false, a, "Expected setInterval not to have fired again after 249 simulated milliseconds");

advanceToTime(250);
assertEquals(true, a, "Expected setInterval to have fired again after 250 simulated milliseconds");
</script>

<script class="js-test" type="text/html">
var a = false;

setTimeout(
  function() { a = true; },
  100);

assertEquals(false, a, "Expected setTimeout not to have fired before advancing milliseconds");

advanceToTime(99);
assertEquals(false, a, "Expected setTimeout not to have fired after 99 simulated milliseconds");

advanceToTime(100);
assertEquals(true, a, "Expected setTimeout to have fired after 100 simulated milliseconds");
</script>

<script class="js-test" type="text/html">
var a = false;

var timeout = setTimeout(
  function() { a = true; },
  100);

clearTimeout(timeout);

advanceToTime(100);
assertEquals(false, a, "Expected cleared setTimeout not to have fired after 100 simulated milliseconds");
</script>

<script class="js-test" type="text/html">
var a = false;

var interval = setInterval(
  function() { a = true; },
  100);

clearInterval(interval);

advanceToTime(100);
assertEquals(false, a, "Expected cleared setInterval not to have fired after 100 simulated milliseconds");
</script>

<script class="js-test" type="text/html">
var then = new Date();
advanceToTime(100);

var now = new Date();
assertEquals(100, now - then, "Expected bobble time to control Date");
</script>

<script type="text/javascript" language="JavaScript">
var assertEquals = function(expected, actual, message) {
  if (expected != actual) { throw(message || ("Expected " + expected + " to equal " + actual)); }
};

var assertThrows = function(fn, message) {
  var threw = false;
  try { fn(); } catch(_) { threw = true; }
  if (!threw) { throw(message || ("Expected " + fn + " to have thrown")); }
};

(function() {
  var result_template = new Template($$('.js-test-result-template')[0].innerHTML);
  var summary_template = new Template($$('.js-test-results-summary-template')[0].innerHTML);
  var failures = [];
  var successes = [];
  var body = document.getElementsByTagName('body')[0];
  
  document.observe('dom:loaded', function() {
    $$('.js-test').each(function(t) {
      var template_env = {
        function_body: t.innerHTML,
        test_result: 'success'
      };
      
      try {
        new Bobble(Date, t.innerHTML);
        successes.push(t.innerHTML);
      } catch(e) {
        template_env.test_result = 'failure';
        template_env.failure_message = e;
        failures.push(e);
      }
      body.insert(result_template.evaluate(template_env));
    });
    
    body.insert(summary_template.evaluate({
      failures: failures.length,
      successes: successes.length
    }));
  });
  
})();

</script>

  </body>
</html>
